name: E2E Tests
on:
  workflow_call:

jobs:
    e2e-test:
        name: E2E Tests - ${{ matrix.provider }}
        runs-on: ${{ matrix.runner }}
        if: ${{ matrix.condition }}
        concurrency:
            group: ${{ matrix.provider }}-${{ github.head_ref || github.run_id }}
            cancel-in-progress: true
        outputs:
            clusterprefix: ${{ needs.build.outputs.clusterprefix }}
            version: ${{ needs.build.outputs.version }}
            pr: ${{ needs.build.outputs.pr }}
        env:
            PUBLIC_REPO: ${{ needs.authorize.outputs.public_repo == 'true' }}
        strategy:
            matrix:
                include:
                    - provider: controller
                      runner: ubuntu-latest
                      condition: ${{ !contains( github.event.pull_request.labels.*.name, 'test e2e') }}
                      ginkgo_filter: "controller"
                    - provider: aws
                      runner: ubuntu-latest
                      condition: ${{ contains( github.event.pull_request.labels.*.name, 'test e2e') }}
                      ginkgo_filter: "provider:cloud"
                    - provider: azure
                      runner: ubuntu-latest
                      condition: ${{ contains( github.event.pull_request.labels.*.name, 'test e2e') }}
                      ginkgo_filter: "provider:cloud"
                    - provider: gcp
                      runner: ubuntu-latest
                      condition: ${{ contains( github.event.pull_request.labels.*.name, 'test e2e') }}
                      ginkgo_filter: "provider:cloud"
                    - provider: onprem
                      runner: self-hosted
                      condition: ${{ contains( github.event.pull_request.labels.*.name, 'test e2e') }}
                      ginkgo_filter: "provider:onprem"
        steps:
            - name: Set public registry env variables
              if: ${{ env.PUBLIC_REPO == 'true' }}
              run: |
                  echo "REGISTRY_REPO=oci://ghcr.io/k0rdent/kcm/charts-ci" >> $GITHUB_ENV
                  echo "IMG=ghcr.io/k0rdent/kcm/controller-ci:${{ needs.build.outputs.version }}" >> $GITHUB_ENV
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{fromJSON(needs.build.outputs.pr).merge_commit_sha}}
            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version-file: "go.mod"
                  cache: true # default
            - name: Setup kubectl
              uses: azure/setup-kubectl@v4
            - name: Load testing configuration
              if: ${{ needs.authorize.outputs.config != '' }}
              run: |
                  echo -n "${{ needs.authorize.outputs.config }}" | base64 -d > test/e2e/config/config.yaml
                  echo "Testing configuration was overwritten:"
                  cat test/e2e/config/config.yaml

            - name: Set aws cloud provider environment variables
              if: matrix.provider == 'aws'
              env:
                AWS_REGION: us-west-2
                AWS_ACCESS_KEY_ID: ${{ secrets.CI_AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.CI_AWS_SECRET_ACCESS_KEY }}
              run: |
                for var in AWS_REGION AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY; do
                  echo "${var}=${!var}" >> $GITHUB_ENV
                done

            - name: Set azure cloud provider environment variables
              if: matrix.provider == 'azure'
              env:
                AZURE_REGION: westus2
                AZURE_SUBSCRIPTION_ID: ${{ secrets.CI_AZURE_SUBSCRIPTION_ID }}
                AZURE_TENANT_ID: ${{ secrets.CI_AZURE_TENANT_ID }}
                AZURE_CLIENT_ID: ${{ secrets.CI_AZURE_CLIENT_ID }}
                AZURE_CLIENT_SECRET: ${{ secrets.CI_AZURE_CLIENT_SECRET }}
              run: |
                for var in AZURE_REGION AZURE_SUBSCRIPTION_ID AZURE_TENANT_ID AZURE_CLIENT_ID AZURE_CLIENT_SECRET; do
                  echo "${var}=${!var}" >> $GITHUB_ENV
                done

            - name: Set gcp cloud provider environment variables
              if: matrix.provider == 'gcp'
              env:
                GCP_B64ENCODED_CREDENTIALS: ${{ secrets.CI_GCP_B64ENCODED_CREDENTIALS }}
                GCP_PROJECT: k0rdent-ci
                GCP_REGION: us-east4
              run: |
                for var in GCP_B64ENCODED_CREDENTIALS GCP_PROJECT GCP_REGION; do
                  echo "${var}=${!var}" >> $GITHUB_ENV
                done

            - name: Set on-prem environment variables
              if: matrix.provider == 'onprem'
              env:
                VSPHERE_USER: ${{ secrets.CI_VSPHERE_USER }}
                VSPHERE_PASSWORD: ${{ secrets.CI_VSPHERE_PASSWORD }}
                VSPHERE_SERVER: ${{ secrets.CI_VSPHERE_SERVER }}
                VSPHERE_THUMBPRINT: ${{ secrets.CI_VSPHERE_THUMBPRINT }}
                VSPHERE_DATACENTER: ${{ secrets.CI_VSPHERE_DATACENTER }}
                VSPHERE_DATASTORE: ${{ secrets.CI_VSPHERE_DATASTORE }}
                VSPHERE_RESOURCEPOOL: ${{ secrets.CI_VSPHERE_RESOURCEPOOL }}
                VSPHERE_FOLDER: ${{ secrets.CI_VSPHERE_FOLDER }}
                VSPHERE_CONTROL_PLANE_ENDPOINT: ${{ secrets.CI_VSPHERE_CONTROL_PLANE_ENDPOINT }}
                VSPHERE_VM_TEMPLATE: ${{ secrets.CI_VSPHERE_VM_TEMPLATE }}
                VSPHERE_NETWORK: ${{ secrets.CI_VSPHERE_NETWORK }}
                VSPHERE_SSH_KEY: ${{ secrets.CI_VSPHERE_SSH_KEY }}
              run: |
                for var in VSPHERE_USER VSPHERE_PASSWORD VSPHERE_SERVER VSPHERE_THUMBPRINT \
                          VSPHERE_DATACENTER VSPHERE_DATASTORE VSPHERE_RESOURCEPOOL VSPHERE_FOLDER \
                          VSPHERE_CONTROL_PLANE_ENDPOINT VSPHERE_VM_TEMPLATE VSPHERE_NETWORK VSPHERE_SSH_KEY; do
                  echo "${var}=${!var}" >> $GITHUB_ENV
                done

            - name: Run E2E tests
              env:
                  GINKGO_LABEL_FILTER: ${{ matrix.ginkgo_filter }}
                  CLUSTER_DEPLOYMENT_PREFIX: ${{ needs.build.outputs.clusterprefix }}
                  VERSION: ${{ needs.build.outputs.version }}
              run: |
                  make test-e2e
            - name: Archive test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: support-bundles-${{ matrix.provider }}
                  path: |
                      *.tar.gz
